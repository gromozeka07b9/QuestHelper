<?xml version="1.0" encoding="utf-8"?>
<ContentPage xmlns="http://xamarin.com/schemas/2014/forms"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:d="http://xamarin.com/schemas/2014/forms/design"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:ffimageloading="clr-namespace:FFImageLoading.Forms;assembly=FFImageLoading.Forms"
             xmlns:local="clr-namespace:QuestHelper.View.Converters" xmlns:animationForms="clr-namespace:Lottie.Forms;assembly=Lottie.Forms" xmlns:animationResource="clr-namespace:QuestHelper.Resources"
             xmlns:xForms="clr-namespace:Syncfusion.RangeNavigator.XForms;assembly=Syncfusion.SfChart.XForms"
             mc:Ignorable="d"
             xmlns:listView="clr-namespace:Syncfusion.ListView.XForms;assembly=Syncfusion.SfListView.XForms"
             x:Class="QuestHelper.View.MakeNewRouteAutoPage"
             NavigationPage.HasNavigationBar="False" NavigationPage.HasBackButton="False"
             Appearing="ContentPage_Appearing" Disappearing="ContentPage_Disappearing">
    <ContentPage.Resources>
        <ResourceDictionary>
            <local:ImageIndexConverter x:Key="imageIndexer" />
            <local:NegativeBoolConverter  x:Key="inverter" />
            <local:ExpandSelectedItemConverter  x:Key="expanderHeight" />
        </ResourceDictionary>
    </ContentPage.Resources>
    <ContentPage.Content>
        <Grid Padding="0" Margin="0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>
            <Grid.RowDefinitions>
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>
            <listView:SfListView Grid.Row="0" Grid.Column="0" Margin="0" x:Name="sfListRoutePoints"
                                 ItemsSource="{Binding PreviewRoutePoints}" TapCommand="{Binding SelectedRoutePoint}"
                                 SwipeOffset="80" SwipeThreshold="30"
                                 SelectionMode="None" AutoFitMode="DynamicHeight" AllowSwiping="False">
                <listView:SfListView.HeaderTemplate>
                    <DataTemplate>
                        <StackLayout HorizontalOptions="FillAndExpand">
                            <Grid HorizontalOptions="FillAndExpand" HeightRequest="200">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="4*" />
                                    <ColumnDefinition Width="2*" />
                                    <ColumnDefinition Width="4*" />
                                </Grid.ColumnDefinitions>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="1*" />
                                    <RowDefinition Height="3*" />
                                    <RowDefinition Height="1*" />
                                    <RowDefinition Height="3*" />
                                    <RowDefinition Height="1*" />
                                </Grid.RowDefinitions>

                                <Image Grid.Column="0" Grid.Row="1" Margin="0" Source="btn1test.png" IsVisible="{Binding IsVisiblePeriodChart, Converter={StaticResource inverter}}"></Image>
                                <!--Frame Grid.Column="0" Grid.Row="1" Margin="0" HasShadow="True" IsVisible="{Binding IsVisiblePeriodChart, Converter={StaticResource inverter}}" BackgroundColor="LightBlue">
                                    <Frame.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding GenerateNewRouteCommand}"></TapGestureRecognizer>
                                    </Frame.GestureRecognizers>
                                    <Label Text="Сегодня" FontSize="16" HorizontalTextAlignment="Center" TextColor="Black"></Label>
                                </-->
                                <Frame Grid.Column="0" Grid.Row="3" Margin="0" HasShadow="True" IsVisible="{Binding IsVisiblePeriodChart, Converter={StaticResource inverter}}" BackgroundColor="LightBlue">
                                    <Frame.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding GenerateNewRouteCommand}"></TapGestureRecognizer>
                                    </Frame.GestureRecognizers>
                                    <Label Text="Вчера" FontSize="16" HorizontalTextAlignment="Center" TextColor="Black"></Label>
                                </Frame>
                                <Frame Grid.Column="2" Grid.Row="1" Margin="0" HasShadow="True" IsVisible="{Binding IsVisiblePeriodChart, Converter={StaticResource inverter}}" BackgroundColor="LightBlue">
                                    <Frame.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding GenerateNewRouteCommand}"></TapGestureRecognizer>
                                    </Frame.GestureRecognizers>
                                    <Label Text="Неделя" FontSize="16" HorizontalTextAlignment="Center" TextColor="Black"></Label>
                                </Frame>
                                <Frame Grid.Column="2"   Grid.Row="3" Margin="0" HasShadow="True" IsVisible="{Binding IsVisiblePeriodChart, Converter={StaticResource inverter}}" BackgroundColor="LightBlue">
                                    <Frame.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding ShowPeriodChartCommand}"></TapGestureRecognizer>
                                    </Frame.GestureRecognizers>
                                    <Label Text="Все дни" FontSize="16" HorizontalTextAlignment="Center" TextColor="Black"></Label>
                                </Frame>
                                <StackLayout Grid.Column="0" Grid.Row="0" Grid.ColumnSpan="3" Grid.RowSpan="5" Margin="5" IsVisible="{Binding IsVisiblePeriodChart}">
                                    <ImageButton Source="baseline_clear_black_48" Command="{Binding ShowMinimalPeriodCommand}" HorizontalOptions="End"></ImageButton>
                                    <xForms:SfDateTimeRangeNavigator HorizontalOptions="FillAndExpand" VerticalOptions="FillAndExpand">
                                     </xForms:SfDateTimeRangeNavigator>
                                </StackLayout>
                            </Grid>
                        </StackLayout>
                    </DataTemplate>
                </listView:SfListView.HeaderTemplate>
                <!--listView:SfListView.SelectedItemTemplate>
                    <DataTemplate>
                        <Frame CornerRadius="5" BorderColor="Black" BackgroundColor="LightGray" HasShadow="True" Padding="0" Margin="5" HeightRequest="80" HorizontalOptions="Fill" VerticalOptions="Fill">
                            <StackLayout Margin="0" Orientation="Horizontal" HorizontalOptions="Fill" VerticalOptions="FillAndExpand">
                                <Frame CornerRadius="50" WidthRequest="70" HeightRequest="70" HorizontalOptions="Start" Padding="0" Margin="5">
                                    <ffimageloading:CachedImage Source="{Binding Images, Converter={StaticResource imageIndexer}, ConverterParameter=0}" HorizontalOptions="Start" VerticalOptions="Fill" Aspect="Fill" Margin="0">
                                    </ffimageloading:CachedImage>
                                </Frame>
                                    <StackLayout Orientation="Vertical" HorizontalOptions="FillAndExpand" VerticalOptions="Center">
                                    <Label Text="{Binding Name}" FontAttributes="Bold" FontSize="16" HorizontalOptions="Start" VerticalOptions="Center"/>
                                    <Label Text="{Binding PointCoordinatesText}" FontSize="14" HorizontalOptions="Start" VerticalOptions="Center"/>
                                </StackLayout>
                            </StackLayout>
                        </Frame>
                    </DataTemplate>
                </-->
                <listView:SfListView.LeftSwipeTemplate>
                    <DataTemplate>
                        <StackLayout HorizontalOptions="Fill" VerticalOptions="Fill">
                            <StackLayout.GestureRecognizers>
                                <TapGestureRecognizer CommandParameter="{Binding .}" ></TapGestureRecognizer>
                            </StackLayout.GestureRecognizers>
                                <Image Grid.Column="0"
                                    Grid.Row="0"
                                    BackgroundColor="Transparent"
                                    HeightRequest="35"
                                    WidthRequest="35"
                                    VerticalOptions="CenterAndExpand" HorizontalOptions="Center"
                                    Source="delete.png" >
                                </Image>
                        </StackLayout>
                    </DataTemplate>
                </listView:SfListView.LeftSwipeTemplate>
                <listView:SfListView.RightSwipeTemplate>
                    <DataTemplate>
                        <Grid HeightRequest="100">
                          <Grid BackgroundColor="White" HorizontalOptions="Fill" VerticalOptions="Fill" Grid.Column="0">
                            <Grid VerticalOptions="Center" HorizontalOptions="Center">
                              <Image Grid.Column="0"
                                    Grid.Row="0"
                                    BackgroundColor="Transparent"
                                    HeightRequest="35"
                                    WidthRequest="35"
                                    Source="edit.png" />
                            </Grid>
                          </Grid>
                        </Grid>
                    </DataTemplate>
                </listView:SfListView.RightSwipeTemplate>
                <listView:SfListView.ItemTemplate>
                    <DataTemplate>
                       <Frame CornerRadius="5" BackgroundColor="LightCyan" HasShadow="True" Padding="0" Margin="5" HeightRequest="{Binding IsSelected, Converter={StaticResource expanderHeight}}" HorizontalOptions="Fill" VerticalOptions="Fill">
                           <StackLayout>
                                <StackLayout Margin="0" HeightRequest="50" Orientation="Horizontal" HorizontalOptions="Fill" VerticalOptions="FillAndExpand">
                                    <StackLayout.GestureRecognizers>
                                        <TapGestureRecognizer Tapped="ListItemTapGestureRecognizer_Tapped" CommandParameter="{Binding .}"></TapGestureRecognizer>
                                    </StackLayout.GestureRecognizers>
                                    <Frame CornerRadius="50" HeightRequest="50" WidthRequest="50" HorizontalOptions="Start" Padding="0" Margin="5">
                                        <ffimageloading:CachedImage HeightRequest="50" WidthRequest="50" DownsampleToViewSize="True" Source="{Binding Images, Converter={StaticResource imageIndexer}, ConverterParameter=0}" HorizontalOptions="Start" VerticalOptions="Fill" Aspect="Fill" Margin="0">
                                        </ffimageloading:CachedImage>
                                    </Frame>
                                    <StackLayout Orientation="Vertical" HorizontalOptions="FillAndExpand" VerticalOptions="Center">
                                        <Label Text="{Binding Name}" FontAttributes="Bold" FontSize="16" HorizontalOptions="Start" VerticalOptions="Center"/>
                                    </StackLayout>
                                </StackLayout>
                               <StackLayout Orientation="Vertical" IsVisible="{Binding IsSelected}">
                                   <BoxView HeightRequest="1" BackgroundColor="Black" Margin="5,0,5,0"></BoxView>
                                   <StackLayout Orientation="Horizontal" Margin="5">
                                       <CollectionView ItemsSource="{Binding Images}" HeightRequest="200" IsGrouped="False" SelectionMode="Single" RemainingItemsThreshold="2">
                                            <CollectionView.ItemsLayout>
                                                <GridItemsLayout Span="1" HorizontalItemSpacing="2" Orientation="Horizontal"></GridItemsLayout>
                                            </CollectionView.ItemsLayout>
                                           <CollectionView.ItemTemplate>
                                               <DataTemplate>
                                                   <StackLayout>
                                                        <ffimageloading:CachedImage Grid.Column="0" Grid.Row="0" Source="{Binding ImagePreviewFileName}" Margin="1"
                                                                                    DownsampleToViewSize="True" CacheType="All" CacheDuration="86400"
                                                                                    BitmapOptimizations="False" Aspect="AspectFill"
                                                                                    HorizontalOptions="FillAndExpand"
                                                                                    VerticalOptions="Fill"
                                                                                    HeightRequest="200" WidthRequest="200"
                                                                                    LoadingPlaceholder="emptyphoto.png" >
                                                            <ffimageloading:CachedImage.GestureRecognizers>
                                                            </ffimageloading:CachedImage.GestureRecognizers>
                                                        </ffimageloading:CachedImage>
                                                   </StackLayout>
                                               </DataTemplate>
                                           </CollectionView.ItemTemplate>
                                       </CollectionView>
                                        <!--ffimageloading:CachedImage Source="{Binding Images, Converter={StaticResource imageIndexer}, ConverterParameter=0}" HorizontalOptions="Start" VerticalOptions="Fill" Aspect="Fill" Margin="0" WidthRequest="100" HeightRequest="100">
                                        </>
                                        <ffimageloading:CachedImage Source="{Binding Images, Converter={StaticResource imageIndexer}, ConverterParameter=0}" HorizontalOptions="Start" VerticalOptions="Fill" Aspect="Fill" Margin="0" WidthRequest="100" HeightRequest="100">
                                        </ffimageloading:CachedImage>
                                        <ffimageloading:CachedImage Source="{Binding Images, Converter={StaticResource imageIndexer}, ConverterParameter=0}" HorizontalOptions="Start" VerticalOptions="Fill" Aspect="Fill" Margin="0" WidthRequest="100" HeightRequest="100">
                                        </ffimageloading:CachedImage-->
                                   </StackLayout>
                               </StackLayout>
                           </StackLayout>
                        </Frame>
                    </DataTemplate>
                </listView:SfListView.ItemTemplate>
            </listView:SfListView>
            <!--AbsoluteLayout Grid.Column="0" Grid.ColumnSpan="2" Grid.Row="0" Grid.RowSpan="6" HorizontalOptions="Fill" VerticalOptions="Fill" Opacity="0.7" BackgroundColor="White" IsVisible="{Binding IsGalleryIndexed, Converter={StaticResource inverter}}">
            </>

            <AbsoluteLayout Grid.Column="0" Grid.ColumnSpan="2" Grid.Row="2" Grid.RowSpan="6" IsVisible="{Binding IsGalleryIndexed, Converter={StaticResource inverter}}" HorizontalOptions="Center">
                <StackLayout VerticalOptions="FillAndExpand" Orientation="Vertical" HorizontalOptions="Center" IsVisible="{Binding IsGalleryIndexed, Converter={StaticResource inverter}}">
                    <Label Text="Нажмите 'Обновить' для обновления списка фотографий" TextColor="Black" FontSize="14" Margin="15" HorizontalTextAlignment="Center"></Label>
                    <Button Text="Обновить" Command="{Binding StartIndexGalleryCommand}" HorizontalOptions="Center" />
                </StackLayout>
                <StackLayout VerticalOptions="FillAndExpand" Orientation="Vertical" HorizontalOptions="Center" IsVisible="{Binding IsGalleryIndexed}" AbsoluteLayout.LayoutBounds=".5,.1,.5,.5" AbsoluteLayout.LayoutFlags="All">
                    <animationForms:AnimationView HorizontalOptions="EndAndExpand" VerticalOptions="CenterAndExpand" Margin="0" AbsoluteLayout.LayoutBounds=".5,.1,.5,.5" AbsoluteLayout.LayoutFlags="All"
                                        Animation="{animationResource:AnimationResourceExtension hourglass}"
                                        Loop="True"
                                        AutoPlay="True"
                                        IsEnabled="True"
                                        IsPlaying="{Binding IsGalleryIndexed}"                                                                      
                                        IsVisible="True"
                                        WidthRequest="100"
                                        HeightRequest="100"                                        
                                        />
                </StackLayout>
            </AbsoluteLayout-->
        </Grid>
    </ContentPage.Content>
</ContentPage>